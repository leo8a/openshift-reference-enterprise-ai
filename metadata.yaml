# OpenShift Validated Reference Design for Enterprise AI
#
# Validated reference configuration for Enterprise AI on OpenShift 4.20+.
# This reference validates the complete AI platform stack including operators, GPU infrastructure,
# serving components, and networking.

apiVersion: v2

parts:

  # ============================================================
  # Foundation Operators Section
  # ============================================================
  - name: Foundation Operators
    description: |
      Core operators required before deploying the OpenShift AI platform.
      Node Feature Discovery (NFD) discovers hardware features.
      Kernel Module Management (KMM) manages out-of-tree kernel modules.
      Both NFD and KMM are required for GPU detection and driver management.

    components:
      - name: Node Feature Discovery
        description: Detects hardware features and system configuration
        allOf:
          - path: common/operators/nfd-operator/00_nfd-namespace.yaml
          - path: common/operators/nfd-operator/01_nfd-operatorgroup.yaml
          - path: common/operators/nfd-operator/02_nfd-sub.yaml
          # - path: common/operators/nfd-operator/03_nodeFeatureRule-cr.yaml

      - name: Kernel Module Management
        description: Manages out-of-tree kernel modules for GPU drivers
        allOf:
          - path: common/operators/kmm-operator/00_kmm-namespace.yaml
          - path: common/operators/kmm-operator/01_kmm-operatorgroup.yaml
          - path: common/operators/kmm-operator/02_kmm-sub.yaml


# ============================================================
# Fields to Omit Section
# ============================================================
fieldsToOmit:
  defaultOmitRef: all
  items:
    defaults:
      # ==========================================
      # Kubernetes-managed metadata fields
      # ==========================================
      - pathToKey: metadata.uid
      - pathToKey: metadata.resourceVersion
      - pathToKey: metadata.generation
      - pathToKey: metadata.creationTimestamp
      - pathToKey: metadata.generateName
      - pathToKey: metadata.finalizers
      - pathToKey: metadata.ownerReferences
      - pathToKey: spec.finalizers
      - pathToKey: spec.ownerReferences

      # ==========================================
      # Kubernetes core annotations
      # ==========================================
      - pathToKey: metadata.annotations."kubernetes.io/metadata.name"
      - pathToKey: metadata.annotations."kubectl.kubernetes.io/last-applied-configuration"

      # ==========================================
      # Kubernetes core labels
      # ==========================================
      - pathToKey: metadata.labels."kubernetes.io/metadata.name"
      - pathToKey: metadata.labels."pod-security.kubernetes.io/"
        isPrefix: true

      # ==========================================
      # OpenShift Security Context Constraints (SCC)
      # ==========================================
      - pathToKey: metadata.annotations."openshift.io/sa.scc.uid-range"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.mcs"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.supplemental-groups"
      - pathToKey: metadata.annotations."security.openshift.io/MinimallySufficientPodSecurityStandard"
      - pathToKey: metadata.labels."security.openshift.io/scc.podSecurityLabelSync"

      # ==========================================
      # OpenShift release and platform annotations
      # ==========================================
      - pathToKey: metadata.annotations."include.release.openshift.io/ibm-cloud-managed"
      - pathToKey: metadata.annotations."include.release.openshift.io/self-managed-high-availability"
      - pathToKey: metadata.annotations."include.release.openshift.io/single-node-developer"
      - pathToKey: metadata.annotations."include.release.openshift.io/hypershift"
      - pathToKey: metadata.annotations."release.openshift.io/create-only"
      - pathToKey: metadata.annotations."capability.openshift.io/name"

      # ==========================================
      # Operator Lifecycle Manager (OLM)
      # ==========================================
      - pathToKey: metadata.annotations."olm.providedAPIs"
      - pathToKey: metadata.labels."olm.operatorgroup.uid"
      - pathToKey: metadata.labels."olm.operatorgroup.uid/"
        isPrefix: true
      - pathToKey: metadata.labels."operators.coreos.com/"
        isPrefix: true

      # ==========================================
      # GitOps and deployment tools
      # ==========================================
      - pathToKey: metadata.annotations."argocd.argoproj.io/sync-wave"
      - pathToKey: metadata.annotations."ran.openshift.io/ztp-deploy-wave"
      - pathToKey: metadata.annotations."ran.openshift.io/ztp-gitops-generated"

      # ==========================================
      # Platform operator-specific annotations
      # ==========================================
      - pathToKey: metadata.annotations."machineconfiguration.openshift.io/mc-name-suffix"
      - pathToKey: metadata.annotations."operator.sriovnetwork.openshift.io/last-network-namespace"
    allowStatusCheck:
      - include: defaults
    all:
      - include: defaults
      - pathToKey: status
