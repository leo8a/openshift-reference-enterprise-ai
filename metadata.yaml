# OpenShift Validated Reference Design for Enterprise AI
#
# Validated reference configuration for Enterprise AI on OpenShift 4.20+.
# This reference validates the complete AI platform stack including operators, GPU infrastructure,
# serving components, and networking.

apiVersion: v2

parts:

  # ============================================================
  # Foundation Operators Section
  # ============================================================
  - name: Foundation Operators
    description: |
      Core operators required before deploying the OpenShift AI platform.
      Node Feature Discovery (NFD) discovers hardware features.
      Kernel Module Management (KMM) manages out-of-tree kernel modules.
      Both NFD and KMM are required for GPU detection and driver management.

    components:
      - name: Node Feature Discovery
        description: Detects hardware features and system configuration
        allOf:
          - path: common/foundation/nfd-operator/00_nfd-namespace.yaml
          - path: common/foundation/nfd-operator/01_nfd-operatorgroup.yaml
          - path: common/foundation/nfd-operator/02_nfd-subscription.yaml
          - path: common/foundation/nfd-operator/03_nodeFeatureDiscovery-cr.yaml
            description: |
              NodeFeatureRule required for AMD GPU detection. For AMD Instinct GPUs, see:
              - https://instinct.docs.amd.com/projects/gpu-operator/en/latest/installation/openshift-olm.html#create-node-feature-discovery-rule
            config:
              ignore-unspecified-fields: true

      - name: Kernel Module Management
        description: Manages out-of-tree kernel modules for GPU drivers
        allOf:
          - path: common/foundation/kmm-operator/00_kmm-namespace.yaml
          - path: common/foundation/kmm-operator/01_kmm-operatorgroup.yaml
          - path: common/foundation/kmm-operator/02_kmm-subscription.yaml


  # ============================================================
  # Storage Backends Section
  # ============================================================
  - name: Storage Backends
    description: |
      Logical Volume Manager Storage (LVMS) operator provides local storage management.
      Creates and manages LVM-based storage classes for persistent volumes.

    components:
      - name: LVMS Operator
        description: |
          LVM Storage operator manages local storage using LVM thin provisioning.
          Provides dynamic provisioning of persistent volumes from local disks.
        allOrNoneOf:
          - path: common/storage/lvms-operator/00_lvms-namespace.yaml
          - path: common/storage/lvms-operator/01_lvms-operatorgroup.yaml
          - path: common/storage/lvms-operator/02_lvms-subscription.yaml
          - path: common/storage/lvms-operator/03_lvmCluster-cr.yaml
          - path: common/storage/lvms-operator/04_storageClass-cr.yaml
            config:
              ignore-unspecified-fields: true


  # ============================================================
  # GPU Infrastructure Section
  # ============================================================
  - name: GPU Infrastructure
    description: |
      GPU vendor-specific operator and configuration.
      REQUIRED: At least one GPU vendor operator (NVIDIA or AMD) must be deployed.
      Best practice: Deploy only one GPU vendor stack unless heterogeneous hardware requires both.
      Once a vendor is identified (namespace exists), ALL of its components must match.

    components:
      - name: NVIDIA GPU Operator
        description: |
          NVIDIA GPU Operator for NVIDIA GPUs (A100, H100, etc.).
          Includes driver installation, device plugin, and optional Multi-Instance GPU (MIG) support.
          See: https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/
        allOrNoneOf:
          - path: vendors/nvidia/gpu-operator/00_nvidia-gpu-namespace.yaml
          - path: vendors/nvidia/gpu-operator/01_nvidia-gpu-operator-operatorgroup.yaml
          - path: vendors/nvidia/gpu-operator/02_nvidia-gpu-operator-subscription.yaml

      - name: AMD GPU Operator
        description: |
          AMD GPU Operator for AMD Instinct GPUs (MI250, MI300, etc.).
          Includes ROCm drivers and device plugin.
          Operator deployed via OLM with automated driver installation.
        allOrNoneOf:
          - path: vendors/amd/gpu-operator/00_amd-gpu-namespace.yaml
          - path: vendors/amd/gpu-operator/01_amd-gpu-opergroup.yaml
          - path: vendors/amd/gpu-operator/02_amd-gpu-subscription.yaml
          - path: vendors/amd/gpu-operator/03_amdgpu-blacklist-mc.yaml
          - path: vendors/amd/gpu-operator/04_device-plugin-config.yaml
            config:
              ignore-unspecified-fields: true


  # ============================================================
  # OpenShift AI Platform Section
  # ============================================================
  - name: OpenShift AI Platform
    description: |
      Red Hat OpenShift AI platform operators and core components.
      Includes RHOAI operator, DataScienceCluster, serving infrastructure dependencies.
      Service Mesh, Serverless, and Authorino are required for model serving features.

    components:
      - name: OpenShift AI Operator
        description: |
          Red Hat OpenShift AI operator and platform configuration.
          Includes DataScienceCluster and HardwareProfile for GPU support.
        allOf:
          - path: common/platform/openshift-ai/00_ocpai-namespace.yaml
          - path: common/platform/openshift-ai/01_ocpai-operatorgroup.yaml
          - path: common/platform/openshift-ai/02_ocpai-subscription.yaml
          - path: common/platform/openshift-ai/03_dataScienceCluster-cr.yaml
          - path: common/platform/openshift-ai/04_hardwareProfile-cr.yaml

      - name: Service Mesh 2
        description: |
          Red Hat OpenShift Service Mesh operator (Istio-based).
          Required for RHOAI model serving and inference gateway functionality.
        allOf:
          - path: common/platform/service-mesh/00_service-mesh2-subscription.yaml

      - name: Serverless
        description: |
          Red Hat OpenShift Serverless operator (Knative-based).
          Required for RHOAI KServe model serving and auto-scaling capabilities.
        allOf:
          - path: common/platform/serverless/00_serverless-namespace.yaml
          - path: common/platform/serverless/01_serverless-operatorgroup.yaml
          - path: common/platform/serverless/02_serverless-subscription.yaml

      - name: Authorino
        description: |
          Red Hat Authorino operator for API authentication and authorization.
          Required for RHOAI model serving security and token-based inference authentication.
        allOf:
          - path: common/platform/authorino/00_authorino-subscription.yaml


# ============================================================
# Fields to Omit Section
# ============================================================
fieldsToOmit:
  defaultOmitRef: all
  items:
    defaults:
      # ==========================================
      # Kubernetes-managed metadata fields
      # ==========================================
      - pathToKey: metadata.uid
      - pathToKey: metadata.resourceVersion
      - pathToKey: metadata.generation
      - pathToKey: metadata.creationTimestamp
      - pathToKey: metadata.generateName
      - pathToKey: metadata.finalizers
      - pathToKey: metadata.ownerReferences
      - pathToKey: spec.finalizers
      - pathToKey: spec.ownerReferences

      # ==========================================
      # Kubernetes core annotations
      # ==========================================
      - pathToKey: metadata.annotations."kubernetes.io/metadata.name"
      - pathToKey: metadata.annotations."kubectl.kubernetes.io/last-applied-configuration"

      # ==========================================
      # Kubernetes core labels
      # ==========================================
      - pathToKey: metadata.labels."kubernetes.io/metadata.name"
      - pathToKey: metadata.labels."pod-security.kubernetes.io/"
        isPrefix: true

      # ==========================================
      # OpenShift Security Context Constraints (SCC)
      # ==========================================
      - pathToKey: metadata.annotations."openshift.io/sa.scc.uid-range"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.mcs"
      - pathToKey: metadata.annotations."openshift.io/sa.scc.supplemental-groups"
      - pathToKey: metadata.annotations."security.openshift.io/MinimallySufficientPodSecurityStandard"
      - pathToKey: metadata.labels."security.openshift.io/scc.podSecurityLabelSync"

      # ==========================================
      # OpenShift release and platform annotations
      # ==========================================
      - pathToKey: metadata.annotations."include.release.openshift.io/ibm-cloud-managed"
      - pathToKey: metadata.annotations."include.release.openshift.io/self-managed-high-availability"
      - pathToKey: metadata.annotations."include.release.openshift.io/single-node-developer"
      - pathToKey: metadata.annotations."include.release.openshift.io/hypershift"
      - pathToKey: metadata.annotations."release.openshift.io/create-only"
      - pathToKey: metadata.annotations."capability.openshift.io/name"

      # ==========================================
      # Operator Lifecycle Manager (OLM)
      # ==========================================
      - pathToKey: metadata.annotations."olm.providedAPIs"
      - pathToKey: metadata.labels."olm.operatorgroup.uid"
      - pathToKey: metadata.labels."olm.operatorgroup.uid/"
        isPrefix: true
      - pathToKey: metadata.labels."operators.coreos.com/"
        isPrefix: true

      # ==========================================
      # GitOps and deployment tools
      # ==========================================
      - pathToKey: metadata.annotations."argocd.argoproj.io/sync-wave"
      - pathToKey: metadata.annotations."ran.openshift.io/ztp-deploy-wave"
      - pathToKey: metadata.annotations."ran.openshift.io/ztp-gitops-generated"

      # ==========================================
      # Platform operator-specific annotations
      # ==========================================
      - pathToKey: metadata.annotations."machineconfiguration.openshift.io/mc-name-suffix"
      - pathToKey: metadata.annotations."operator.sriovnetwork.openshift.io/last-network-namespace"
    allowStatusCheck:
      - include: defaults
    all:
      - include: defaults
      - pathToKey: status
